

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>Ledger &#8212; CCF  documentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Consensus Protocols" href="consensus.html" />
    <link rel="prev" title="Key-Value Store API" href="kv/api.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

    
    <a class="navbar-brand" href="../index.html">
      <img src="../_static/ccf.svg" class="logo" alt="logo">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-11 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../introduction.html">Introduction</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../concepts.html">Concepts</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../quickstart/index.html">Start Here</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../members/index.html">Governance</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="index.html">Building Apps</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../operators/index.html">Operations</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../users/index.html">Using Apps</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../glossary.html">Glossary</a>
        </li>
        
        
      </ul>

      <ul class="navbar-nav">
        
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/Microsoft/CCF" target="_blank" rel="noopener">
              <span><i class="fab fa-github-square"></i></span>
            </a>
          </li>
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>


<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

  <div class="bd-toc-item active">
  

  <ul class="nav bd-sidenav">
      
      
      
      
      
      
      
      
      
      
        
          
              <li class="">
                  <a href="example.html">Example Application</a>
              </li>
          
        
          
              <li class="">
                  <a href="build_app.html">Build and Sign Application</a>
              </li>
          
        
          
              <li class="">
                  <a href="demo.html">End-to-end demo</a>
              </li>
          
        
          
              <li class="">
                  <a href="kv/index.html">Key-Value Store</a>
              </li>
          
        
          
              <li class="active">
                  <a href="">Ledger</a>
              </li>
          
        
          
              <li class="">
                  <a href="consensus.html">Consensus Protocols</a>
              </li>
          
        
          
              <li class="">
                  <a href="cryptography.html">Cryptography</a>
              </li>
          
        
          
              <li class="">
                  <a href="threading.html">Threading</a>
              </li>
          
        
          
              <li class="">
                  <a href="performance.html">Performance</a>
              </li>
          
        
          
              <li class="">
                  <a href="api.html">Developer API</a>
              </li>
          
        
      
      
      
      
      
      
      
      
    </ul>

    
      <ul>
        <li>
          <a href="ledger.html" class="badge">v0.10</a>
        </li>
      </ul>
      <ul>
        <li>
          <a href="../../master/developers/ledger.html" class="badge">master</a>
        </li>
      </ul>
    

</nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#ledger-encryption" class="nav-link">Ledger Encryption</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#ledger-replication" class="nav-link">Ledger Replication</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#reading-and-verifing-ledger" class="nav-link">Reading and Verifing Ledger</a>
        </li>
    
    </ul>
</nav>



<div class="tocsection editthispage">
    <a href="https://github.com/Microsoft/CCF/edit/master/doc/developers/ledger.rst">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="ledger">
<h1>Ledger<a class="headerlink" href="#ledger" title="Permalink to this headline">¶</a></h1>
<p>The ledger is the persistent distributed append-only record of the transactions that have been executed by the network. It is written by the primary when a transaction is committed and replicated to all backups which maintain their own duplicated copy.</p>
<p>A node writes its ledger to a file as specified by the <code class="docutils literal notranslate"><span class="pre">--ledger-file</span></code> command line argument.</p>
<div class="section" id="ledger-encryption">
<h2>Ledger Encryption<a class="headerlink" href="#ledger-encryption" title="Permalink to this headline">¶</a></h2>
<p>Each entry in the ledger corresponds to a transaction (or delta) committed by the primary’s key-value store.</p>
<p>When a transaction is committed, each affected <code class="docutils literal notranslate"><span class="pre">Store::Map</span></code> is serialised in different security domains (i.e. public or private), based on the policy set when the <code class="docutils literal notranslate"><span class="pre">Store::Map</span></code> was created (default is private). Public <code class="docutils literal notranslate"><span class="pre">Store::Map</span></code> are serialised and stored in the ledger as plaintext while private <code class="docutils literal notranslate"><span class="pre">Store::Map</span></code> are serialised and encrypted before being stored.</p>
<p>Ledger entries are integrity-protected and encrypted using a symmetric key shared by all trusted nodes (see <a class="reference internal" href="cryptography.html#algorithms-and-curves"><span class="std std-ref">Algorithms and Curves</span></a>). This key is kept secure inside each enclave. See <a class="reference internal" href="../members/common_member_operations.html#rekeying-ledger"><span class="std std-ref">Rekeying Ledger</span></a> for details on how members can rotate the ledger encryption key.</p>
<p>Note that even if a transaction only affects a private <code class="docutils literal notranslate"><span class="pre">Store::Map</span></code>, unencrypted information such as the version number is always present in the serialised entry. More information about the ledger entry format is available in the <a class="reference internal" href="kv/kv_serialisation.html#serialised-format"><span class="std std-ref">Serialised Format</span></a> section.</p>
</div>
<div class="section" id="ledger-replication">
<h2>Ledger Replication<a class="headerlink" href="#ledger-replication" title="Permalink to this headline">¶</a></h2>
<p>The replication process currently uses Raft as the consensus algorithm and therefore the terminology changes slightly. Instead of primary we use the term leader and instead of backup we use the term follower.</p>
<p>As such, the replicated process relies on authenticated Append Entries (AE) headers sent from the leader to followers and which specify the start and end index of the encrypted deltas payload. When an AE header is emitted from a node’s enclave for replication, the corresponding encrypted deltas are read from the ledger and appended to the AE header.</p>
<p>The following diagram describes how deltas committed by the leader are written to the ledger and how they are replicated to one follower. Note that the full replication process and acknowledgment from the follower is not detailed here.</p>
<script>mermaid.initialize({startOnLoad:true});</script><div class="mermaid">
            sequenceDiagram
    participant Leader KV
    participant Leader Raft
    participant Leader Host
    participant Leader Ledger

    participant Follower Ledger
    participant Follower Host
    participant Follower Raft
    participant Follower KV

    Note left of Leader KV: tx.commit(): Serialise transaction based on maps security domain
    Leader KV-&gt;&gt;+Leader Raft: replicate (batch of serialised deltas)

    loop for each serialised delta in batch
        Leader Raft-&gt;&gt;+Leader Host: log_append (delta)
        Leader Host-&gt;&gt;+Leader Ledger: write(delta)

        Leader Raft-&gt;&gt;+Leader Host: node_outbound (AE)
        Leader Raft--&gt;&gt;+Leader KV: replicate success

        Note right of Leader Host: Append Ledger entries to AE
        loop for each entry in AE
            Leader Host-&gt;&gt;+Leader Ledger: read(entry's index)
            Leader Ledger--&gt;&gt;Leader Host: delta
        end
        Leader Host-&gt;&gt;+Follower Host: TCP packet (AE + deltas)

        Follower Host-&gt;&gt;+Follower Raft: node_inbound (AE + deltas)

        Follower Raft-&gt;&gt;Follower Raft: recv_authenticated (AE + deltas)
        loop for each delta
            Follower Raft-&gt;&gt;Follower Host: log_append (delta)
            Follower Host-&gt;&gt;+Follower Ledger: write(delta)
            Follower Raft-&gt;&gt;Follower KV: deserialise(delta)
            Follower KV--&gt;&gt;+Follower Raft: deserialise success
        end

    end
        </div></div>
<div class="section" id="reading-and-verifing-ledger">
<h2>Reading and Verifing Ledger<a class="headerlink" href="#reading-and-verifing-ledger" title="Permalink to this headline">¶</a></h2>
<p>A Python implementation for parsing the ledger can be found in <a class="reference external" href="https://github.com/microsoft/CCF/blob/master/tests/ledger.py">ledger.py</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Ledger</span></code> class is constructed using the path of the ledger. It then exposes an iterator for transaction data structures, where each transaction is composed of the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>The GCM header (gcm_header)</p></li>
<li><p>The serialised public domain, containing operations made only on public tables (get_public_domain)</p></li>
</ul>
</div></blockquote>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>Parsing the encrypted private data (which begins immediately after the public data on the ledger, and is optional) is not supported by the <code class="docutils literal notranslate"><span class="pre">Ledger</span></code> class at the moment.</p>
</div>
<p>An example of how to read and verify entries on the ledger can be found in <a class="reference external" href="https://github.com/microsoft/CCF/blob/master/tests/governance_history.py">governance_history.py</a>, which verifies the voting history.
Since every vote request is signed by the voting member, verified by the primary and then stored on the ledger, the test performs the following (this sequence of operations is performed sequentially per transaction):</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Read and store the member certificates</p></li>
<li><p>Read an entry from the <code class="docutils literal notranslate"><span class="pre">ccf.governance.history</span></code> table (each entry in the table contains the member id of the voting member, along with the signed request)</p></li>
<li><p>Create a public key using the certificate of the voting member (which was stored on step 1)</p></li>
<li><p>Verify the signature using the public key and the raw request</p></li>
<li><p>Repeat steps 2 - 4 until all voting history entries have been read</p></li>
</ol>
</div></blockquote>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="kv/api.html" title="previous page">Key-Value Store API</a>
    <a class='right-next' id="next-link" href="consensus.html" title="next page">Consensus Protocols</a>

              </div>
              
          </main>
          

      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2018, Microsoft Research.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>