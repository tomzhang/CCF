

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>Catastrophic Recovery &#8212; CCF  documentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Node Output" href="node_output.html" />
    <link rel="prev" title="Starting a New Network" href="start_network.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

    
    <a class="navbar-brand" href="../index.html">
      <img src="../_static/ccf.svg" class="logo" alt="logo">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-11 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../introduction.html">Introduction</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../concepts.html">Concepts</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../quickstart/index.html">Start Here</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../members/index.html">Governance</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../developers/index.html">Building Apps</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="index.html">Operations</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../users/index.html">Using Apps</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../glossary.html">Glossary</a>
        </li>
        
        
      </ul>

      <ul class="navbar-nav">
        
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/Microsoft/CCF" target="_blank" rel="noopener">
              <span><i class="fab fa-github-square"></i></span>
            </a>
          </li>
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>


<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

  <div class="bd-toc-item active">
  

  <ul class="nav bd-sidenav">
      
      
      
      
      
      
      
      
      
      
      
      
        
          
              <li class="">
                  <a href="start_network.html">Starting a New Network</a>
              </li>
          
        
          
              <li class="active">
                  <a href="">Catastrophic Recovery</a>
              </li>
          
        
          
              <li class="">
                  <a href="node_output.html">Node Output</a>
              </li>
          
        
          
              <li class="">
                  <a href="operator_rpc_api.html">Operator RPC API</a>
              </li>
          
        
          
              <li class="">
                  <a href="resource_usage.html">Resource Usage</a>
              </li>
          
        
      
      
      
      
      
      
    </ul>

    
      <ul>
        <li>
          <a href="recovery.html" class="badge">v0.10</a>
        </li>
      </ul>
      <ul>
        <li>
          <a href="../../master/operators/recovery.html" class="badge">master</a>
        </li>
      </ul>
    

</nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#establishing-a-recovered-public-network" class="nav-link">Establishing a Recovered Public Network</a>
        </li>
    
    </ul>
</nav>



<div class="tocsection editthispage">
    <a href="https://github.com/Microsoft/CCF/edit/master/doc/operators/recovery.rst">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="catastrophic-recovery">
<h1>Catastrophic Recovery<a class="headerlink" href="#catastrophic-recovery" title="Permalink to this headline">¶</a></h1>
<p>For unexpected reasons, a significant number <a class="footnote-reference brackets" href="#crash" id="id1">1</a> of CCF nodes may become unavailable. In this catastrophic scenario, operators and members can recover transactions that were committed on the crashed service by starting a new network.</p>
<p>The recovery procedure consists of two phases:</p>
<ol class="arabic simple">
<li><p>Operators should retrieve one of the ledgers of the previous service and re-start one or several nodes in <code class="docutils literal notranslate"><span class="pre">recover</span></code> mode. The public transactions of the previous network are restored and the new network established.</p></li>
<li><p>After agreeing that the configuration of the new network is suitable, members should vote to accept to recover the network and once this is done, submit their recovery shares to initiate the end of the recovery procedure. See <a class="reference internal" href="../members/accept_recovery.html#accepting-recovery-and-submitting-shares"><span class="std std-ref">here</span></a> for more details.</p></li>
</ol>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>It is possible that the length of the ledgers of each node may differ slightly since some transactions may not have yet been fully replicated. It is preferable to use the ledger of the primary node before the service crashed.</p>
</div>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>Before attempting to recover a network, it is recommended to make a copy of all available ledgers.</p>
</div>
<div class="section" id="establishing-a-recovered-public-network">
<h2>Establishing a Recovered Public Network<a class="headerlink" href="#establishing-a-recovered-public-network" title="Permalink to this headline">¶</a></h2>
<p>To initiate the first phase of the recovery procedure, one or several nodes should be started with the <code class="docutils literal notranslate"><span class="pre">recover</span></code> option:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cchost
--enclave-file /path/to/enclave_library
--node-address node_ip:node_port
--rpc-address &lt;ccf-node-address&gt;
--public-rpc-address &lt;ccf-node-public-address&gt;
<span class="o">[</span>--domain domain<span class="o">]</span>
--ledger-file /path/to/ledger/to/recover
--node-cert-file /path/to/node_certificate
recover
--network-cert-file /path/to/network_certificate
</pre></div>
</div>
<p>Each node will then immediately restore the public entries of its ledger (<code class="docutils literal notranslate"><span class="pre">--ledger-file</span></code>). Because deserialising the public entries present in the ledger may take some time, operators can query the progress of the public recovery by calling <code class="docutils literal notranslate"><span class="pre">getSignedIndex</span></code> which returns the version of the last signed recovered ledger entry. Once the public ledger is fully recovered, the recovered node automatically becomes part of the public network, allowing other nodes to join the network.</p>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>If more than one node were started in <code class="docutils literal notranslate"><span class="pre">recover</span></code> mode, the node with the highest signed index (as per the response to the <code class="docutils literal notranslate"><span class="pre">getSignedIndex</span></code> RPC) should be preferred to start the new network. Other nodes should be shutdown and new nodes restarted with the <code class="docutils literal notranslate"><span class="pre">join</span></code> option.</p>
</div>
<p>Similarly to the normal join protocol (see <a class="reference internal" href="start_network.html#adding-a-new-node-to-the-network"><span class="std std-ref">Adding a New Node to the Network</span></a>), other nodes are then able to join the network.</p>
<script>mermaid.initialize({startOnLoad:true});</script><div class="mermaid">
            sequenceDiagram
    participant Operators
    participant Node 2
    participant Node 3

    Operators-&gt;&gt;+Node 2: cchost --rpc-address=ip2:port2 --ledger-file=ledger0 recover
    Node 2--&gt;&gt;Operators: Network Certificate
    Note over Node 2: Reading Public Ledger...

    Operators-&gt;&gt;+Node 2: getSignedIndex
    Node 2--&gt;&gt;Operators: {&quot;signed_index&quot;: 50, &quot;state&quot;: &quot;readingPublicLedger&quot;}
    Note over Node 2: Finished Reading Public Ledger, now Part of Public Network
    Operators-&gt;&gt;Node 2: getSignedIndex
    Node 2--&gt;&gt;Operators: {&quot;signed_index&quot;: 243, &quot;state&quot;: &quot;partOfPublicNetwork&quot;}

    Note over Operators, Node 2: Operators select Node 2 to start the new network

    Operators-&gt;&gt;+Node 3: cchost join --network-cert-file=Network Certificate --target-rpc-address=ip2:port2
    Node 3-&gt;&gt;+Node 2: Join network (over TLS)
    Node 2--&gt;&gt;Node 3: Join network response

    Note over Node 3: Part of Public Network
        </div><p>Once operators have established a recovered public network, the existing members of the consortium <a class="reference internal" href="../members/accept_recovery.html#accepting-recovery-and-submitting-shares"><span class="std std-ref">must vote to accept the recovery of the network and submit their recovery shares</span></a>.</p>
<div class="alert alert-warning">
<p class="admonition-title">Warning</p>
<p>After recovery, the identity of the network has changed. The new network certificate <code class="docutils literal notranslate"><span class="pre">networkcert.pem</span></code> must be distributed to all existing and new users.</p>
</div>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="crash"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>When using Raft as consensus algorithm, CCF tolerates up to <cite>N/2 - 1</cite> crashed nodes (where <cite>N</cite> is the number of nodes constituting the network) before having to perform the catastrophic recovery procedure. For example, in a 5-node network, no more than 2 nodes are allowed to fail.</p>
</dd>
</dl>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="start_network.html" title="previous page">Starting a New Network</a>
    <a class='right-next' id="next-link" href="node_output.html" title="next page">Node Output</a>

              </div>
              
          </main>
          

      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2018, Microsoft Research.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>